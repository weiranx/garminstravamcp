server {
    listen 443 ssl;
    server_name ${GARMIN_DOMAIN};

    ssl_certificate /etc/letsencrypt/live/${GARMIN_DOMAIN}/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/${GARMIN_DOMAIN}/privkey.pem;

    # OAuth discovery metadata
    location /.well-known/oauth-authorization-server {
        proxy_pass http://localhost:8101/.well-known/oauth-authorization-server;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    # OAuth authorization endpoint (user-facing approve/deny page)
    location /authorize {
        proxy_pass http://localhost:8101/authorize;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    # OAuth token endpoint
    location /oauth/token {
        proxy_pass http://localhost:8101/oauth/token;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    # MCP endpoint (auth handled by oauth-proxy)
    location /mcp {
        proxy_pass http://localhost:8101/mcp;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_cache_bypass $http_upgrade;
    }

    # Health check
    location /health {
        proxy_pass http://localhost:8101/health;
    }
}
